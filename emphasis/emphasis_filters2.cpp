/*!****************************************************************************
* @file    emphasis_filters.c
* @author  INFERION
* @version V1.3
* @date    05.05.2020, INFERION
* @brief   --
*/

#include "stdafx.h"

/*!****************************************************************************
* Include
*/
//#include <stdint.h>
//#include <math.h>
#include "emphasis_filters2.h"

/*****************************************************************************/

void sinc_x2(SINC_Interpolation_TypeDef *Context, float *In, float *Out, uint32_t len){
	const float filter_cores[2][128] = {
		0.00000000008743507991,-0.00000000502075187194,0.00000004527948601880,-0.00000020570800133490,0.00000064934917235531,-0.00000163165046345053,0.00000350127354400817,-0.00000668456715666434,0.00001165189386899649,-0.00001886537682505078,0.00002870917670223596,-0.00004140503126591496,0.00005691738985887406,-0.00007485394811685928,0.00009436863087713088,-0.00011407498782773669,0.00013197847440992624,-0.00014543612592892753,0.00015115165497078895,-0.00014521299684989200,0.00012317780941472091,-0.00008021044601341753,0.00001127153622551673,0.00008864137323939525,-0.00022420652426788099,0.00039945130440754631,-0.00061739634734940421,0.00087968299239170658,-0.00118619882811418103,0.00153471760225152546,-0.00192057066250597101,0.00233636720500202989,-0.00277177988099609664,0.00321341071417431505,-0.00364474981109415936,0.00404623604097629260,-0.00439542478406456001,0.00466726309076006315,-0.00483446726201744708,0.00486799206049558144,-0.00473757457646544963,0.00441232923696602362,-0.00386136350180071733,0.00305437621624580439,-0.00196219190293414137,0.00055717354901957590,0.00118655798917126788,-0.00329319094032052163,0.00578570193460084276,-0.00868692818767012945,0.01202150684580441560,-0.01581912332878544075,0.02011982146388616860,-0.02498273067814994058,0.03050079357638998609,-0.03682673880666616217,0.04422176335849270501,-0.05315435261253873694,0.06452289061089018507,-0.08023288892058086375,0.10503124808239742982,-0.15462543918043586411,0.32874667757758485598,0.86927533008530399883,-0.14689123645826404618,0.06503140840492875607,-0.03274345835364226437,0.01528181774030140661,-0.00438021303427864502,-0.00293758214031859853,0.00801099486705916103,-0.01153876177650854998,0.01392856601692149358,-0.01544158303680718582,0.01625946287789077280,-0.01651801273295720740,0.01632513829568675232,-0.01577076471107375852,0.01493242620543532365,-0.01387841401855329469,0.01266951029484681898,-0.01135989682228479535,0.00999759162081773761,-0.00862463284935295268,0.00727714995218032516,-0.00598541206789931796,0.00477391077300407494,-0.00366151139597551724,0.00266169065478330611,-0.00178286613342940048,0.00102881392246024226,-0.00039916390914318891,-0.00011004270218538258,0.00050575229940054683,-0.00079727463269356274,0.00099565634522941161,-0.00111307249010864280,0.00116225460970703458,-0.00115597150592072675,0.00110657577276475783,-0.00102562569131208121,0.00092358839741112433,-0.00080962651573697486,0.00069146688777949310,-0.00057534676550204426,0.00046603003082234878,-0.00036688373837373675,0.00028000363696340571,-0.00020637634103795466,0.00014606550011830307,-0.00009840962157890633,0.00006222008066096261,-0.00003596921637425411,0.00001796015844806586,-0.00000647204085821255,-0.00000012359286138753,0.00000327722275644640,-0.00000420659267572476,0.00000387087292004473,-0.00000297030349434208,0.00000196668154207233,-0.00000111926692059045,0.00000053031239443454,-0.00000019447165859346,0.00000004676786866328,-0.00000000456524728652,0.00000000000733818077,-0.00000000058587010029,	//1
		0.00000000000733818076,-0.00000000456524728384,0.00000004676786863589,-0.00000019447165847954,0.00000053031239412389,-0.00000111926691993479,0.00000196668154092025,-0.00000297030349260209,0.00000387087291777722,-0.00000420659267326058,0.00000327722275452660,-0.00000012359286131513,-0.00000647204085442127,0.00001796015843754490,-0.00003596921635318369,0.00006222008062451439,-0.00009840962152125841,0.00014606550003273846,-0.00020637634091706086,0.00028000363679938153,-0.00036688373815881850,0.00046603003054935139,-0.00057534676516500971,0.00069146688737443496,-0.00080962651526270200,0.00092358839687009281,-0.00102562569071127404,0.00110657577211653309,-0.00115597150524356595,0.00116225460902619334,-0.00111307248945661380,0.00099565634464616136,-0.00079727463222652401,0.00050575229910428078,-0.00011004270212092035,-0.00039916390890936152,0.00102881392185757113,-0.00178286613238500804,0.00266169065322410543,-0.00366151139383063227,0.00477391077020755238,-0.00598541206439310615,0.00727714994791741829,-0.00862463284430070413,0.00999759161496121922,-0.01135989681563024344,0.01266951028742510296,-0.01387841401042341945,0.01493242619668801521,-0.01577076470183535681,0.01632513828612359649,-0.01651801272328107598,0.01625946286836608967,-0.01544158302776161597,0.01392856600876223906,-0.01153876176974922597,0.00801099486236637667,-0.00293758213859778407,-0.00438021303171274700,0.01528181773134942682,-0.03274345833446138526,0.06503140836683381221,-0.14689123637221621066,0.86927532957608877329,0.32874667738500734648,-0.15462543908985737495,0.10503124802087088208,-0.08023288887358102917,0.06452289057309312792,-0.05315435258140129710,0.04422176333258793363,-0.03682673878509330062,0.03050079355852283736,-0.02498273066351524782,0.02011982145210012077,-0.01581912331951871795,0.01202150683876230218,-0.00868692818258138579,0.00578570193121162243,-0.00329319093839139290,0.00118655798847619063,0.00055717354869318789,-0.00196219190178470362,0.00305437621445657590,-0.00386136349953876239,0.00441232923438131513,-0.00473757457369021300,0.00486799205764394671,-0.00483446725918545289,0.00466726308802601665,-0.00439542478148975679,0.00404623603860603410,-0.00364474980895908816,0.00321341071229192367,-0.00277177987937240805,0.00233636720363340246,-0.00192057066138091566,0.00153471760135249873,-0.00118619882741931347,0.00087968299187639592,-0.00061739634698773833,0.00039945130417355120,-0.00022420652413654259,0.00008864137318746983,0.00001127153621891395,-0.00008021044596643111,0.00012317780934256451,-0.00014521299676482704,0.00015115165488224566,-0.00014543612584373233,0.00013197847433261435,-0.00011407498776091282,0.00009436863082185041,-0.00007485394807301031,0.00005691738982553218,-0.00004140503124166032,0.00002870917668541842,-0.00001886537681399962,0.00001165189386217091,-0.00000668456715274858,0.00000350127354195715,-0.00000163165046249474,0.00000064934917197494,-0.00000020570800121440,0.00000004527948599228,-0.00000000502075186900,0.00000000008743507986,-0.00000000000007803391,	//2
	};
	for(uint32_t loop=0; loop<len; loop++){
		Context->oversmpl_buffer[Context->ovsmpl_lp] = In[loop];//Вход фильтра
		Out[loop*4+0] = 0;
		Out[loop*4+1] = 0;
		for(uint32_t i=0; i<128; i++){
			float X = Context->oversmpl_buffer[(Context->ovsmpl_lp+i)&127];
			Out[loop*4+0] += X * filter_cores[0][i];
			Out[loop*4+1] += X * filter_cores[1][i];
		}
		Context->ovsmpl_lp = (Context->ovsmpl_lp+1)&127;
	}
}

void sinc_x4(SINC_Interpolation_TypeDef *Context, float *In, float *Out, uint32_t len){
	const float filter_cores[4][128] = {
		0.00000000008743507991,-0.00000000502075187194,0.00000004527948601880,-0.00000020570800133490,0.00000064934917235531,-0.00000163165046345053,0.00000350127354400817,-0.00000668456715666434,0.00001165189386899649,-0.00001886537682505078,0.00002870917670223596,-0.00004140503126591496,0.00005691738985887406,-0.00007485394811685928,0.00009436863087713088,-0.00011407498782773669,0.00013197847440992624,-0.00014543612592892753,0.00015115165497078895,-0.00014521299684989200,0.00012317780941472091,-0.00008021044601341753,0.00001127153622551673,0.00008864137323939525,-0.00022420652426788099,0.00039945130440754631,-0.00061739634734940421,0.00087968299239170658,-0.00118619882811418103,0.00153471760225152546,-0.00192057066250597101,0.00233636720500202989,-0.00277177988099609664,0.00321341071417431505,-0.00364474981109415936,0.00404623604097629260,-0.00439542478406456001,0.00466726309076006315,-0.00483446726201744708,0.00486799206049558144,-0.00473757457646544963,0.00441232923696602362,-0.00386136350180071733,0.00305437621624580439,-0.00196219190293414137,0.00055717354901957590,0.00118655798917126788,-0.00329319094032052163,0.00578570193460084276,-0.00868692818767012945,0.01202150684580441560,-0.01581912332878544075,0.02011982146388616860,-0.02498273067814994058,0.03050079357638998609,-0.03682673880666616217,0.04422176335849270501,-0.05315435261253873694,0.06452289061089018507,-0.08023288892058086375,0.10503124808239742982,-0.15462543918043586411,0.32874667757758485598,0.86927533008530399883,-0.14689123645826404618,0.06503140840492875607,-0.03274345835364226437,0.01528181774030140661,-0.00438021303427864502,-0.00293758214031859853,0.00801099486705916103,-0.01153876177650854998,0.01392856601692149358,-0.01544158303680718582,0.01625946287789077280,-0.01651801273295720740,0.01632513829568675232,-0.01577076471107375852,0.01493242620543532365,-0.01387841401855329469,0.01266951029484681898,-0.01135989682228479535,0.00999759162081773761,-0.00862463284935295268,0.00727714995218032516,-0.00598541206789931796,0.00477391077300407494,-0.00366151139597551724,0.00266169065478330611,-0.00178286613342940048,0.00102881392246024226,-0.00039916390914318891,-0.00011004270218538258,0.00050575229940054683,-0.00079727463269356274,0.00099565634522941161,-0.00111307249010864280,0.00116225460970703458,-0.00115597150592072675,0.00110657577276475783,-0.00102562569131208121,0.00092358839741112433,-0.00080962651573697486,0.00069146688777949310,-0.00057534676550204426,0.00046603003082234878,-0.00036688373837373675,0.00028000363696340571,-0.00020637634103795466,0.00014606550011830307,-0.00009840962157890633,0.00006222008066096261,-0.00003596921637425411,0.00001796015844806586,-0.00000647204085821255,-0.00000012359286138753,0.00000327722275644640,-0.00000420659267572476,0.00000387087292004473,-0.00000297030349434208,0.00000196668154207233,-0.00000111926692059045,0.00000053031239443454,-0.00000019447165859346,0.00000004676786866328,-0.00000000456524728652,0.00000000000733818077,-0.00000000058587010029,	//1
		0.00000000009243638285,-0.00000000835042226539,0.00000007004646647700,-0.00000028608833998420,0.00000081444376013334,-0.00000185734294482007,0.00000363343719408266,-0.00000633536198951774,0.00001007458355229318,-0.00001481682484221140,0.00002031267361420572,-0.00002602907613058577,0.00003108822765288466,-0.00003422081000459169,0.00003374054023981755,-0.00002754654766128021,0.00001315917899933293,0.00001220653981839675,-0.00005152733833727897,0.00010781770728086308,-0.00018393751801751347,0.00028236580001975918,-0.00040494772769633446,0.00055262424459883548,-0.00072515586128410567,0.00092085387074428745,-0.00113633341266174484,0.00136630338464364086,-0.00160340807042215721,0.00183813448772187911,-0.00205879784228947581,0.00225161513599186295,-0.00240087397917700769,0.00248920009920778132,-0.00249792304885060584,0.00240753535783392626,-0.00219823601697282777,0.00185054492854610174,-0.00134597099551671782,0.00066771304776072236,0.00019863000569736124,-0.00126436539697723314,0.00253705573041791395,-0.00401993786541137224,0.00571143701081217644,-0.00760479942455621200,0.00968786390703186076,-0.01194298812540375496,0.01434714084493733492,-0.01687216554777528840,0.01948521489712628368,-0.02214934928688596510,0.02482428654909888538,-0.02746728402411452788,0.03003412887373840476,-0.03248020796167247481,0.03476162503620370409,-0.03683633048919882080,0.03866522775092353509,-0.04021322048050891135,0.04145016614252578641,-0.04235170428238590329,0.04289993173535492504,0.95691609765336782534,0.04289993173535492504,-0.04235170428238590329,0.04145016614252578641,-0.04021322048050893216,0.03866522775092353509,-0.03683633048919882080,0.03476162503620370409,-0.03248020796167247481,0.03003412887373841864,-0.02746728402411451400,0.02482428654909888538,-0.02214934928688597551,0.01948521489712628368,-0.01687216554777528840,0.01434714084493733492,-0.01194298812540375496,0.00968786390703187117,-0.00760479942455621893,0.00571143701081218078,-0.00401993786541137224,0.00253705573041791482,-0.00126436539697723314,0.00019863000569736133,0.00066771304776072301,-0.00134597099551671782,0.00185054492854610174,-0.00219823601697283037,0.00240753535783392756,-0.00249792304885060757,0.00248920009920778132,-0.00240087397917700769,0.00225161513599186165,-0.00205879784228947928,0.00183813448772188301,-0.00160340807042215938,0.00136630338464363891,-0.00113633341266174592,0.00092085387074428810,-0.00072515586128410567,0.00055262424459883689,-0.00040494772769633414,0.00028236580001975896,-0.00018393751801751377,0.00010781770728086325,-0.00005152733833727902,0.00001220653981839675,0.00001315917899933292,-0.00002754654766128019,0.00003374054023981764,-0.00003422081000459180,0.00003108822765288473,-0.00002602907613058583,0.00002031267361420576,-0.00001481682484221141,0.00001007458355229325,-0.00000633536198951779,0.00000363343719408265,-0.00000185734294482009,0.00000081444376013335,-0.00000028608833998421,0.00000007004646647700,-0.00000000835042226539,0.00000000009243638285,-0.00000000008036814126,		//2
		0.00000000000733818076,-0.00000000456524728384,0.00000004676786863589,-0.00000019447165847954,0.00000053031239412389,-0.00000111926691993479,0.00000196668154092025,-0.00000297030349260209,0.00000387087291777722,-0.00000420659267326058,0.00000327722275452660,-0.00000012359286131513,-0.00000647204085442127,0.00001796015843754490,-0.00003596921635318369,0.00006222008062451439,-0.00009840962152125841,0.00014606550003273846,-0.00020637634091706086,0.00028000363679938153,-0.00036688373815881850,0.00046603003054935139,-0.00057534676516500971,0.00069146688737443496,-0.00080962651526270200,0.00092358839687009281,-0.00102562569071127404,0.00110657577211653309,-0.00115597150524356595,0.00116225460902619334,-0.00111307248945661380,0.00099565634464616136,-0.00079727463222652401,0.00050575229910428078,-0.00011004270212092035,-0.00039916390890936152,0.00102881392185757113,-0.00178286613238500804,0.00266169065322410543,-0.00366151139383063227,0.00477391077020755238,-0.00598541206439310615,0.00727714994791741829,-0.00862463284430070413,0.00999759161496121922,-0.01135989681563024344,0.01266951028742510296,-0.01387841401042341945,0.01493242619668801521,-0.01577076470183535681,0.01632513828612359649,-0.01651801272328107598,0.01625946286836608967,-0.01544158302776161597,0.01392856600876223906,-0.01153876176974922597,0.00801099486236637667,-0.00293758213859778407,-0.00438021303171274700,0.01528181773134942682,-0.03274345833446138526,0.06503140836683381221,-0.14689123637221621066,0.86927532957608877329,0.32874667738500734648,-0.15462543908985737495,0.10503124802087088208,-0.08023288887358102917,0.06452289057309312792,-0.05315435258140129710,0.04422176333258793363,-0.03682673878509330062,0.03050079355852283736,-0.02498273066351524782,0.02011982145210012077,-0.01581912331951871795,0.01202150683876230218,-0.00868692818258138579,0.00578570193121162243,-0.00329319093839139290,0.00118655798847619063,0.00055717354869318789,-0.00196219190178470362,0.00305437621445657590,-0.00386136349953876239,0.00441232923438131513,-0.00473757457369021300,0.00486799205764394671,-0.00483446725918545289,0.00466726308802601665,-0.00439542478148975679,0.00404623603860603410,-0.00364474980895908816,0.00321341071229192367,-0.00277177987937240805,0.00233636720363340246,-0.00192057066138091566,0.00153471760135249873,-0.00118619882741931347,0.00087968299187639592,-0.00061739634698773833,0.00039945130417355120,-0.00022420652413654259,0.00008864137318746983,0.00001127153621891395,-0.00008021044596643111,0.00012317780934256451,-0.00014521299676482704,0.00015115165488224566,-0.00014543612584373233,0.00013197847433261435,-0.00011407498776091282,0.00009436863082185041,-0.00007485394807301031,0.00005691738982553218,-0.00004140503124166032,0.00002870917668541842,-0.00001886537681399962,0.00001165189386217091,-0.00000668456715274858,0.00000350127354195715,-0.00000163165046249474,0.00000064934917197494,-0.00000020570800121440,0.00000004527948599228,-0.00000000502075186900,0.00000000008743507986,-0.00000000000007803391,	//3
		0.00000000000000000000,-0.00000000108501638881,0.00000001402509877026,-0.00000005224374379111,0.00000010095049555466,-0.00000008075805366737,-0.00000018842177654437,0.00000101836508765807,-0.00000287345069200886,0.00000637680642425897,-0.00001229763241878509,0.00002151665542434950,-0.00003496800361150447,0.00005355739134410799,-0.00007805828616666730,0.00010898959812249544,-0.00014648027582197007,0.00019012790048281283,-0.00023885982539713688,0.00029080650812585135,-0.00034319733385757977,0.00039228935774326886,-0.00043333895283267579,0.00046062531786641585,-0.00046753318575918929,0.00044669992117517374,-0.00039022957759044728,0.00028997350345756314,-0.00013787387207339280,-0.00007363679018830105,0.00035119022352835130,-0.00070000431872287085,0.00112338792945688147,-0.00162224623679924052,0.00219460551059066011,-0.00283517646298555529,0.00353497476122860465,-0.00428101557676005117,0.00505609623564131586,-0.00583867705690650513,0.00660286527929276803,-0.00731850052100399811,0.00795133237183216421,-0.00846327124354981711,0.00881268204709312851,-0.00895467578638544336,0.00884133525974185354,-0.00842178508597760285,0.00764197851328564989,-0.00644401546122370418,0.00476471245129884806,-0.00253298611962206842,-0.00033466975155643845,0.00394185640584360664,-0.00842535269499788270,0.01397796840170440098,-0.02089015084263522865,0.02963035589845528298,-0.04101327921835482004,0.05659230981913341424,-0.07972425166400230745,0.11918812703377144879,-0.20727629304935904497,0.63496814634309595160,0.63496814634309595160,-0.20727629304935904497,0.11918812703377144879,-0.07972425166400234908,0.05659230981913341424,-0.04101327921835482004,0.02963035589845529685,-0.02089015084263522865,0.01397796840170439578,-0.00842535269499788617,0.00394185640584360838,-0.00033466975155643834,-0.00253298611962206929,0.00476471245129884806,-0.00644401546122370678,0.00764197851328565509,-0.00842178508597759938,0.00884133525974186221,-0.00895467578638544856,0.00881268204709312851,-0.00846327124354981711,0.00795133237183215900,-0.00731850052100400678,0.00660286527929277237,-0.00583867705690650860,0.00505609623564131846,-0.00428101557676005291,0.00353497476122860465,-0.00283517646298555876,0.00219460551059066271,-0.00162224623679923944,0.00112338792945688233,-0.00070000431872287128,0.00035119022352835173,-0.00007363679018830105,-0.00013787387207339280,0.00028997350345756314,-0.00039022957759044674,0.00044669992117517439,-0.00046753318575919005,0.00046062531786641541,-0.00043333895283267611,0.00039228935774326886,-0.00034319733385757966,0.00029080650812585233,-0.00023885982539713745,0.00019012790048281251,-0.00014648027582197035,0.00010898959812249566,-0.00007805828616666735,0.00005355739134410826,-0.00003496800361150444,0.00002151665542434946,-0.00001229763241878514,0.00000637680642425899,-0.00000287345069200886,0.00000101836508765808,-0.00000018842177654437,-0.00000008075805366737,0.00000010095049555466,-0.00000005224374379111,0.00000001402509877026,-0.00000000108501638881,0.00000000000000000000	//4
	};
	for(uint32_t loop=0; loop<len; loop++){
		Context->oversmpl_buffer[Context->ovsmpl_lp] = In[loop];//Вход фильтра
		Out[loop*4+0] = 0;
		Out[loop*4+1] = 0;
		Out[loop*4+2] = 0;
		Out[loop*4+3] = 0;
		for(uint32_t i=0; i<128; i++){
			float X = Context->oversmpl_buffer[(Context->ovsmpl_lp+i)&127];
			Out[loop*4+0] += X * filter_cores[0][i];
			Out[loop*4+1] += X * filter_cores[1][i];
			Out[loop*4+2] += X * filter_cores[2][i];
			Out[loop*4+3] += X * filter_cores[3][i];
		}
		Context->ovsmpl_lp = (Context->ovsmpl_lp+1)&127;
	}
}

void pre_emphasis(Emphasis_TypeDef *Context, float *In, float *Out, uint32_t len, float sampleRate){
	float x = 1.0f/(Pre_Emphasis_T2*sampleRate);
	float point = 0.50f-0.2f*x;
	for(uint32_t i=0; i<len; i++){
		float k = (In[i]-Context->X1)*x;
		Context->X1 += (In[i]-(Context->X1+k*point))*x;
		Out[i] = In[i]+(In[i]-Context->X1)*(Pre_Emphasis_T1/Pre_Emphasis_T2);
	}
}

void de_emphasis(Emphasis_TypeDef *Context, float *In, float *Out, uint32_t len, float sampleRate){
	float x = 1.0f/(De_Emphasis_T1*sampleRate);
	float point = 0.50f-0.2f*x;
	for(uint32_t i=0; i<len; i++){
		float k = (In[i]-Context->X1)*x;
		Context->X1 += (In[i]-(Context->X1+k*point))*x;
		Out[i] = (Context->X1+In[i]*(De_Emphasis_T2/De_Emphasis_T1))*(1.0f/(1.0f+De_Emphasis_T2/De_Emphasis_T1));
	}
}

/***************** (C) COPYRIGHT *********** END OF FILE ******** INFERION ****/
